<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Админ-панель</title>

  <!-- Подключаем CSS с параметром версии для обхода кеша -->
  <link id="adminCss" rel="stylesheet" href="" />

  <!-- Манифест PWA -->
  <link rel="manifest" href="manifest-admin.json" />
  <meta name="theme-color" content="#4caf50" />

  <script>
    // Вставляем уникальный параметр версии в ссылку на CSS для обхода кеша
    const link = document.getElementById('adminCss');
    link.href = `admin.css?v=${Date.now()}`;
  </script>
</head>
<body>
  <h1>Админ-панель</h1>

  <!-- Кнопка установки PWA -->
  <button id="installBtn" style="display:none; margin-bottom:20px;">Скачать приложение</button>

  <div id="loginSection">
    <label>Введите пароль:
      <input type="password" id="adminPassword" />
    </label>
    <button id="loginBtn">Войти</button>
    <p id="loginStatus"></p>
  </div>

  <div id="adminPanel" style="display:none;">
    <h2>Настройки игрока</h2>

    <label>Дерево:
      <input type="number" id="woodInput" />
    </label>
    <label>Рабочие:
      <input type="number" id="workersInput" />
    </label>
    <button onclick="updateStats()">Сохранить изменения</button>

    <h2>Достижения</h2>
    <button onclick="unlockAllAchievements()">Открыть все</button>
    <button onclick="resetAchievements()">Сбросить достижения</button>

    <h2>Сброс прогресса</h2>
    <button onclick="resetProgress()">Сбросить всё</button>

    <p class="success" id="adminMessage"></p>
  </div>

  <script>
    const CORRECT_PASSWORD = '200613a';

    document.getElementById('loginBtn').addEventListener('click', () => {
      const inputPassword = document.getElementById('adminPassword').value;
      if (inputPassword === CORRECT_PASSWORD) {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'block';
        loadStats();
      } else {
        document.getElementById('loginStatus').textContent = 'Неверный пароль.';
      }
    });

    function loadStats() {
      const wood = localStorage.getItem('wood') || 0;
      const workers = localStorage.getItem('workers') || 0;
      document.getElementById('woodInput').value = wood;
      document.getElementById('workersInput').value = workers;
    }

    function updateStats() {
      const wood = parseInt(document.getElementById('woodInput').value, 10);
      const workers = parseInt(document.getElementById('workersInput').value, 10);
      localStorage.setItem('wood', wood);
      localStorage.setItem('workers', workers);
      showMessage('Данные успешно обновлены.');
    }

    function unlockAllAchievements() {
      const achievements = {
        achievement1: true,
        achievement2: true,
        achievement3: true,
        achievement4: true,
        achievement5: true
      };
      localStorage.setItem('achievements', JSON.stringify(achievements));
      showMessage('Все достижения открыты.');
    }

    function resetAchievements() {
      localStorage.removeItem('achievements');
      showMessage('Достижения сброшены.');
    }

    function resetProgress() {
      localStorage.clear();
      showMessage('Прогресс сброшен.');
    }

    function showMessage(text) {
      const msg = document.getElementById('adminMessage');
      msg.textContent = text;
      setTimeout(() => {
        msg.textContent = '';
      }, 3000);
    }

    // --- Регистрация Service Worker ---
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log('Service Worker зарегистрирован'))
        .catch(err => console.error('Ошибка регистрации Service Worker:', err));
    }

    // --- Обработка установки PWA ---
    let deferredPrompt;
    const installBtn = document.getElementById('installBtn');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'inline-block';
    });

    installBtn.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const choiceResult = await deferredPrompt.userChoice;
      if (choiceResult.outcome === 'accepted') {
        console.log('Пользователь принял установку приложения');
      } else {
        console.log('Пользователь отклонил установку приложения');
      }
      deferredPrompt = null;
      installBtn.style.display = 'none';
    });
  </script>
</body>
</html>
